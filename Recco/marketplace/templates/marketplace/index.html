{% extends 'base.html' %}

{% block title %}Marketplace — ReCo{% endblock %}

{% block content %}
  <div class="container d-flex flex-column gap-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <h1 class="h3 mb-1">Marketplace</h1>
        <p class="text-muted mb-0">Filtre por cidade, estado de conservação ou palavras-chave para encontrar o componente certo.</p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'marketplace:chats' %}">Meus chats</a>
        {% if user.is_authenticated %}
          <a class="btn btn-primary" href="{% url 'marketplace:create' %}">Anunciar item</a>
        {% else %}
          <a class="btn btn-primary" href="{% url 'usuario:login' %}">Entrar para anunciar</a>
        {% endif %}
      </div>
    </div>

    <form class="filter-bar" method="get">
      <div class="flex-grow-1">
        <label class="form-label">Buscar</label>
        <input class="form-control" type="text" name="q" value="{{ filters.search }}" placeholder="Ex.: notebook, placa, monitor">
      </div>
      <div>
        <label class="form-label">Condição</label>
        <select class="form-select" name="condition">
          <option value="">Todas</option>
          {% for value, label in condition_choices %}
            <option value="{{ value }}" {% if filters.condition == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label">Cidade</label>
        <select class="form-select" name="city">
          <option value="">Todas</option>
          {% for city in city_choices %}
            <option value="{{ city }}" {% if filters.city == city %}selected{% endif %}>{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label">Ordenar por</label>
        <select class="form-select" name="order">
          <option value="recent" {% if filters.order == 'recent' %}selected{% endif %}>Mais recentes</option>
          <option value="oldest" {% if filters.order == 'oldest' %}selected{% endif %}>Mais antigos</option>
          <option value="name" {% if filters.order == 'name' %}selected{% endif %}>Nome</option>
        </select>
      </div>
      <div>
        <button class="btn btn-secondary" type="submit">Aplicar filtros</button>
      </div>
    </form>

    {% if donations %}
      <div class="card-grid">
        {% for donation in donations %}
          <article class="donation-card">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="h5 mb-0">{{ donation.title }}</h3>
              <span class="pill">{{ donation.get_condition_display }}</span>
            </div>
            <p class="text-muted small mb-2">{{ donation.city|default:'Cidade não informada' }} &middot; Publicado em {{ donation.created_at|date:"d/m" }}</p>
            <p class="mb-2">{{ donation.description|default:"Sem descrição"|truncatechars:140 }}</p>
            <p class="text-muted small mb-3">Anunciado por {{ donation.donor.get_full_name|default:donation.donor.username }}</p>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-primary btn-sm" href="{% url 'marketplace:detail' donation.pk %}">Ver detalhes</a>
              {% if user.is_authenticated %}
                <a class="btn btn-primary btn-sm" href="{% url 'marketplace:chat' donation.pk %}">Abrir chat</a>
              {% else %}
                <a class="btn btn-primary btn-sm" href="{% url 'usuario:login' %}">Entrar para conversar</a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <section class="section-card text-center">
        <h2 class="h4">Ainda não temos itens nesse filtro</h2>
        <p class="text-muted">Remova alguns filtros ou volte mais tarde para ver novos anúncios.</p>
        {% if user.is_authenticated %}
          <a class="btn btn-primary" href="{% url 'marketplace:create' %}">Anunciar o primeiro item</a>
        {% endif %}
      </section>
    {% endif %}
  </div>
{% endblock %}