{% extends 'base.html' %}

{% block title %}Criar conta — ReCo{% endblock %}

{% block content %}
  <div class="container">
    <section class="form-card">
      <h1 class="h3 mb-3">Crie sua conta</h1>
      <p class="text-muted">Preencha os dados principais para publicar doações ou solicitar itens. Leva menos de 2 minutos.</p>

      <form method="post" action="{% url 'usuario:register' %}" class="mt-4">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Usuário</label>
            {{ form.username }}
            {{ form.username.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            {{ form.email }}
            {{ form.email.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Nome completo</label>
            {{ form.first_name }}
            {{ form.first_name.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefone</label>
            {{ form.phone }}
            {{ form.phone.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Cidade</label>
            {{ form.city }}
            {{ form.city.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Tipo de usuário</label>
            {{ form.user_type }}
            {{ form.user_type.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">CPF/CNPJ</label>
            {{ form.cpf_cnpj }}
            {{ form.cpf_cnpj.errors }}
          </div>
          <div class="col-md-6" id="razao-wrap" style="display:none;">
            <label class="form-label">Razão social</label>
            {{ form.razao_social }}
            {{ form.razao_social.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Data de nascimento</label>
            {{ form.birth_date }}
            {{ form.birth_date.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Senha</label>
            {{ form.password1 }}
            {{ form.password1.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Confirmar senha</label>
            {{ form.password2 }}
            {{ form.password2.errors }}
          </div>
        </div>

        <button class="btn btn-primary w-100 mt-4" type="submit">Criar conta</button>
      </form>

      <p class="text-center mt-3 mb-0">Já tem conta? <a href="{% url 'usuario:login' %}">Entre por aqui</a>.</p>
    </section>
  </div>

  <script>
    (function(){
      const userTypeEl = document.querySelector('select[name="user_type"]');
      const razaoWrap = document.getElementById('razao-wrap');
      const cpfEl = document.querySelector('input[name="cpf_cnpj"]');
      const dateEl = document.querySelector('input[name="birth_date"]');

      function toggleRazao() {
        if (!userTypeEl || !razaoWrap) return;
        razaoWrap.style.display = userTypeEl.value === 'pj' ? 'block' : 'none';
      }

      function maskCpfCnpj(value) {
        let digits = value.replace(/\D/g, '').slice(0, 14);
        if (digits.length <= 11) {
          digits = digits.replace(/(\d{3})(\d)/, '$1.$2');
          digits = digits.replace(/(\d{3})(\d)/, '$1.$2');
          digits = digits.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
          digits = digits.replace(/(\d{2})(\d)/, '$1.$2');
          digits = digits.replace(/(\d{3})(\d)/, '$1.$2');
          digits = digits.replace(/(\d{3})(\d)/, '$1/$2');
          digits = digits.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
        }
        return digits;
      }

      function maskDate(value) {
        let digits = value.replace(/\D/g, '').slice(0, 8);
        if (digits.length >= 5) {
          return digits.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
        }
        if (digits.length >= 3) {
          return digits.replace(/(\d{2})(\d{1,2})/, '$1/$2');
        }
        return digits;
      }

      if (cpfEl) {
        cpfEl.addEventListener('input', function(){
          this.value = maskCpfCnpj(this.value);
        });
      }

      if (dateEl) {
        dateEl.addEventListener('input', function(){
          this.value = maskDate(this.value);
        });
      }

      if (userTypeEl) {
        userTypeEl.addEventListener('change', toggleRazao);
        toggleRazao();
      }
    })();
  </script>
{% endblock %}